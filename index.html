<!DOCTYPE html>
<html lang="en">
<head>
  <title>Fish Movement</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/6.1.5/css/bootstrap-slider.css" rel="stylesheet">
  <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/6.1.5/bootstrap-slider.js"></script>
   
  <link rel="stylesheet" href="css/ice.css">
  <link rel="stylesheet" href="css/movement.css">

</head>


<body>

    <!-- Navigation bar -->
    <nav class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span> 
          </button>
          <a class="navbar-brand" href="#">Visualising movements</a>
        </div>
        <div class="collapse navbar-collapse" id="myNavbar">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="#">WHO</a></li>
            <li><a href="#">WHAT</a></li>
            <li><a href="#">WHERE</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Content -->
    <div class="container-fluid">

        <!-- Page Header -->
        <div class="row">
          
            <div class="col-lg-7">
                <h3 class="page-header">Brook trout in a small stream in western MA, USA
                    <small></small>
                </h3>
            </div>

           <div class="col-lg-5">
             <form class="form-inline"> 
              
                <select class="form-control" id="selectedSpeciesDD">
                  <option selected="selected" value="bkt">BrookT</option>
                  <option value="bnt">BrownT</option>
                  <option value="ats">Salmon</option>
                </select>
                <select class="form-control" id="selectedRiverDD">
                  <option selected="selected" value="WB">WB</option>
                  <option value="OL">OL</option>
                  <option value="OS">OS</option>
                  <option value="IL">IL</option>
                </select>
           
                <div class="btn-group btn-group-sm">
                  <button type="button" class="btn btn-default" id="unselectAll">Unselect all</button>
                  <select class="form-control" id="dotOptionDD">
                    <option selected="selected" value="all">All</option>
                    <option value="selected">Selected</option>
                  </select>
                </div>
       
                <div class="btn-group btn-group-sm">
                  <select class="form-control" id="barOptionDD">
                    <option selected="selected" value="yes">Show Bars</option>
                    <option value="no">No Bars</option>
                  </select>
                  <select class="form-control" id="barVariableDD">
                    <option selected="selected" value="count">Count</option>
                    <option value="biomass">Biomass</option>
                  </select>
                </div>
                
              </form>
            </div>
         
        
    
        <!-- /.row -->

        <!-- Graphs Row -->
        <div class="row" id="graphs">
            <div class="col-lg-6">
              <div id="chart1"></div>
                <h4>
                    <a href="#">Absolute position</a>
                </h4>
            </div>
            <div class="col-lg-6" >
              <div id="chart2"></div>
              <h4>
                <a href="#">Movement distance</a>
              </h4>
            </div>
        </div>
        <!-- /.row -->

        <hr>

        <!-- Slider section -->
        <div class="row">
            <div class="col-lg-11">
                <div class="sliderSection" id="slider">
                  <input id="sampleSlider">

                </div>
            </div>
            <div class="col-lg-1">

                <div id="yearLabel">year</div>
                <div id="seasonLabel">season</div>

            </div>  
        </div>
        <!-- /.slider -->

        <hr>

        <!-- Info section -->
        <div class="row">
            <div class="col-lg-12">
                <div class="infoSection">
                    
                        <p> Dots are individual fish, with radius proportional to body length. Move the slider to advance seasonal samples. Recaptured fish will change y-axis position if they were observed to move and change x-axis position based on body growth. Newly tagged fish on the sample will initially appear as green and fish that are never seen again will turn red and disappear.  </p>
  <p>Select individual fish by clicking on a dot. Selected fish will trace out a body size/location vector for the previous sampling interval. View just the selected fish by choosing selected in the dropdown.</p>
  
  <p> Bars on the sides of the graphs sum up the count or biomass (depending on which radio button is selected) for each section (left) or distance moved (right).</p>
                    
                </div>
            </div>
        </div>
        <!-- /.row -->

        <hr>

        <!-- Footer -->
        <footer>
            <div class="row">
                <div class="col-lg-12">
                    <p>Data from USGS Conte Lab <a href="http://www.lsc.usgs.gov/?q=cafb-population-dynamics-personnel">Ecology Section</a></p>
                </div>
            </div>
            <!-- /.row -->
        </footer>

    </div>
    <!-- /.container -->

    <script type='text/javascript' src="js/globalVariables.js"></script>   
    <script type='text/javascript' src="js/functions.js"></script>
    
    <script>


         
     function render(state,seconds) {
       console.log('render', state);
       updateAxes(state,seconds);
       updateRenderData(state);
       $("#seasonLabel").html(state.currentSampleDataAll[0].season);
       $("#yearLabel").html(state.currentSampleDataAll[0].year);
       
       getBarData1(state);
       getBarData2(state);

       render1(state,seconds);
       render2(state,seconds);
     }
     
//////////////////////////////      
///// Absolute position //////

    function render1(state,seconds){
       console.log('render1',state);
             
/////////////////////////////////////////////////////////////////////////
// Bars - put before circles so circles are on top
/////////////////////////////////////////////////////////////////////////    
// Update absolute position plots 
///////////////////////////////////////////////////////////////////////// 

      // BIND DATA
      var bars = svg1.selectAll("rect")
            .data(state.barData1);
      
      // APPEND NEW bar for each data element that doesn't already have a bar
      bars.enter().append("rect")
            .style("fill-opacity", 1e-6)
            .on('mouseover', tipBar.show)
            .on('mouseout', tipBar.hide)
      ;

      // UPDATE the color/position/size of each bar that has a data element
      bars
        .transition()
          .duration(1000*seconds)
            .attr("fill", function(d) {
				     	return "rgb(" + (barGreyBase - d * barGreyMult) + ", " + (barGreyBase - d * barGreyMult) + ", " + (barGreyBase - d * barGreyMult) + ")";
			      })
            .style("fill-opacity", 1)
            .attr("x", function(d, i) {
			   		  return xScale(state.maxLength) - barScale1(d);
			      })
			      .attr("y", function(d,i) {
			   	  	return yScale(i+1.5);// ; 
			      })
			      .attr("height", (h/state.maxSection/1.75 ))
			      .attr("width", function(d) {
			   	  	return barScale1(d); //barScale1(d);
			      })
        ;
  
      // REMOVE any existing bars that no longer have data
      bars.exit()
   //       .style("fill", "red")
          .transition()
          .duration(1000*seconds)
          .style("fill-opacity", 1e-3)
       .remove();
          
/////////////////////////////////////////////////////////////////////////
// Circles
/////////////////////////////////////////////////////////////////////////    
// Update absolute position plots 
///////////////////////////////////////////////////////////////////////// 

      // BIND DATA
      var circles = svg1.selectAll("circle")
            .data(state.renderData, keyID);

      // APPEND NEW CIRCLE for each data element that doesn't already have a circle
      circles.enter().append("circle")
        .style("fill",  "green") //function(d  ){ return colorScale( color(d) ); })
        .style("fill-opacity", 1e-6)
        
        .on("click", clickDot)
    //   .on('mouseover', mouseOverDot))   
        .on('mouseover', tip.show) 
   //     .on('mouseout', mouseOutDot)
        .on('mouseout', tip.hide)
      ;


      // UPDATE the color/position/size of each circle that has a data element
      circles
        .transition()
        .duration(1000*seconds)
          .style("fill", colorWithSelected)// function(d  ){ return colorScale( color(d) ); })
          .style("fill-opacity", 1)
          .call(position)
      ;

      // REMOVE any existing circles that no longer have data
      circles.exit()
        .style("fill", "red")
        .transition()
        .duration(1000*seconds/3)
          .style("fill-opacity", 1e-3)
        .remove();
       
/////Trace lines
//
     if (state.currentSample > state.sampSet[0]) {

        console.log(state.selectedID);
     
        var circleLine = svg1.selectAll("line")
           .data(state.previousSampleDataSelected,keyID);

          circleLine.enter()
            .append("line")
            .attr("stroke", function(d){ return colorScale(color(d)); })
            .attr("stroke-width", 2);

          circleLine
            .attr("x1",function(d) { return xScale(x(d)); })
            .attr("y1",function(d) { return yScale(y(d)); })
            .data(state.currentSampleDataSelected,keyID)
              .transition()
              .duration(1000*seconds)
                .attr("x2", function(d) { return xScale(x(d)); })
                .attr("y2", function(d) { return yScale(y(d)); }) 

          ;
          
          circleLine.exit().remove();
      }
  }
  
//////////////////////////////      
///// Relative position //////

    function render2(state,seconds){
      console.log('render2');

/////////////////////////////////////////////////////////////////////////
// Bars - put before circles so circles are on top
/////////////////////////////////////////////////////////////////////////    
// Update relative position plots 
/////////////////////////////////////////////////////////////////////////

      // BIND DATA
      var bars = svg2.selectAll("rect")
            .data(state.barData2);
      
      // APPEND NEW bar for each data element that doesn't already have a bar
      bars.enter().append("rect")
            .style("fill-opacity", 1e-6)
            .on('mouseover', tipBar.show)
            .on('mouseout', tipBar.hide)
      ;

      // UPDATE the color/position/size of each bar that has a data element
      bars
        .transition()
          .duration(1000*seconds)
            .attr("fill", function(d) {
				     	return "rgb(" + (barGreyBase - d * barGreyMult) + ", " + (barGreyBase - d * barGreyMult) + ", " + (barGreyBase - d * barGreyMult) + ")";
			      })
            .style("fill-opacity", 1)
            .attr("x", function(d, i) {
			   		  return xScale2(state.maxLength) - barScale2(d + 0.0001) ;
			      })
			      .attr("y", function(d,i) {
			   	  	return yScale2Bar(i);// ; 
			      })
			      .attr("height", (h/state.maxSection/3.25 ))
			      .attr("width", function(d) {
			   	  	return barScale2(d + 0.0001);
			      })
        ;
  
      // REMOVE any existing bars that no longer have data
      bars.exit()
   //       .style("fill", "red")
          .transition()
          .duration(1000*seconds)
          .style("fill-opacity", 1e-3)
       .remove();
    
            
/////////////////////////////////////////////////////////////////////////
// Circles
/////////////////////////////////////////////////////////////////////////    
// Update relative position plots 
/////////////////////////////////////////////////////////////////////////

      // BIND DATA
      var circles2 = svg2.selectAll("circle")
            .data(state.renderData2, keyID);

      // APPEND NEW CIRCLE for each data element that doesn't already have a circle
      circles2.enter().append("circle")
        .style("fill",  "green") //function(d  ){ return colorScale( color(d) ); })
        .style("fill-opacity", 1e-6)
        
        .on("click", clickDot)
        .on('mouseover', mouseOverDot)   
        .on('mouseover', tip.show) 
   //     .on('mouseout', mouseOutDot)
        .on('mouseout', tip.hide)
      ;


      // UPDATE the color/position/size of each circle that has a data element
      circles2
        .transition()
        .duration(1000*seconds)
          .style("fill", colorWithSelected)// function(d  ){ return colorScale( color(d) ); })
          .style("fill-opacity", 1)
          .call(position2)
      ;

      // REMOVE any existing circles that no longer have data
      circles2.exit()
        .style("fill", "red")
        .transition()
        .duration(1000*seconds/3)
          .style("fill-opacity", 1e-3)
        .remove();
    
         };


       // get data and filter based on selections
       d3.csv("coreDataOut.csv", type,  function (csvData){
         
         state.allData = csvData;
 
         initializeChart();
         initializeState();
         initializeInterface();
         updateRiverSpecies(state);
         initializeAxes(state);
         render(state,1);


       });
        
    </script>



</body>
</html>