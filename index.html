<!DOCTYPE html>
<html lang="en">
<head>
  <title>Fish Movement</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/6.1.5/css/bootstrap-slider.css" rel="stylesheet">
  <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/6.1.5/bootstrap-slider.js"></script>
   
  <link rel="stylesheet" href="css/ice.css">
  <link rel="stylesheet" href="css/movement.css">

</head>


<body>

    <!-- Navigation bar -->
    <nav class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span> 
          </button>
          <a class="navbar-brand" href="#">Visualising individual fish movements with raw data</a>
        </div>
        <div class="collapse navbar-collapse" id="myNavbar">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="#">WHO</a></li>
            <li><a href="#">WHAT</a></li>
            <li><a href="#">WHERE</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Content -->
    <div class="container-fluid">

        <!-- Page Header -->
        <div class="row">
          
            <div class="col-lg-10">
                <h3 class="page-header">Trout and salmon in a small stream network in western MA, USA
                    <small></small>
                </h3>
            </div>

           <div class="col-lg-2">

             <form class="form-inline-vertical"> 
             
             
         <!--    <div class="btn-toolbar">  -->
               <div class="form-group form-group-sm">
       
          <!--        <select class="form-control" id="selectedSpeciesDD">
                    <option selected="selected" value="bkt">BrookT</option>
                    <option value="bnt">BrownT</option>
                    <option value="ats">Salmon</option>
                  </select>
           -->       
                  
                  
                   <div class="form-group">
                    <label for="selectedSpeciesDD" class="col-xs-4">Species</label>
                      <div class="col-xs-8">
                      
                        <select class="form-control" id="selectedSpeciesDD">
                          <option selected="selected" value="bkt">BrookT</option>
                          <option value="bnt">BrownT</option>
                          <option value="ats">Salmon</option>
                        </select>
                      </div>
                   </div>

                   <div class="form-group">
                    <label for="selectedRiverDD" class="col-xs-4">River</label>
                      <div class="col-xs-8">
                        <select class="form-control" id="selectedRiverDD">
                          <option selected="selected" value="WB">WB</option>
                          <option value="OL">OL</option>
                          <option value="OS">OS</option>
                          <option value="IL">IL</option>
                        </select>
                      </div>
                   </div>
                  
                   <div class="form-group">
                    <label for="dotOptionDD" class="col-xs-4">Fish</label>
                      <div class="col-xs-8">
                        <select class="form-control" id="dotOptionDD">
                          <option selected="selected" value="all">All</option>
                          <option value="selected">Selected</option>
                        </select>
                      </div>
                   </div>
             

                  <div class="form-group">
                    <label for="barOptionDD" class="col-xs-4">Bars?</label>
                      <div class="col-xs-8">
                        <select class="form-control" id="barOptionDD">
                          <option selected="selected" value="yes">Yes</option>
                          <option value="no">No</option>
                        </select>
                     </div>
                   </div>
                  
                  <div class="form-group">
                    <label for="barVariableDD" class="col-xs-4">Bar</label>
                      <div class="col-xs-8">
                        <select class="form-control" id="barVariableDD">
                          <option selected="selected" value="count">Count</option>
                          <option value="biomass">Biomass</option>
                        </select>
                     </div>
                   </div>                      
                  

                  <div class="form-group">
                    <label for="linesDD" class="col-xs-4">Lines</label>
                      <div class="col-xs-8">
                        <select class="form-control" id="linesDD">
                          <option selected="selected" value="all">All</option>
                          <option value="before">Past</option>
                          <option value="after">Future</option>
                          <option value="none">None</option>
                        </select>
                     </div>
                   </div>    

                  <div class="form-group">
                    <label for="onClickDD" class="col-xs-4">Click</label>
                      <div class="col-xs-8">  
                        <select class="form-control" id="onClickDD">
                          <option selected="selected" value="ind">Individual</option>
                          <option value="fam">Family</option>
                        </select>
                     </div>
                   </div>
                   
                   <button type="button" class="btn btn-default btn-sm  pull-right" id="unselectAll">Unselect all</button>
                   
               </div>
             </form>
           </div>
         
        <!-- /.row -->

        <!-- Graphs Row -->
        <div class="row" id="graphs">
            <div class="col-lg-6">
              <div id="chart1"></div>
                <h4>
                  <a href="#">Absolute position</a>
                </h4>
            </div>
            <div class="col-lg-6" >
              <div id="chart2"></div>
              <h4>
                <a href="#">Movement distance</a>
              </h4>
            </div>
        </div>
        <!-- /.row -->

        <hr>

        <!-- Slider section -->
        <div class="row">
            <div class="col-lg-11">
                <div class="sliderSection" id="slider">
                  <input id="sampleSlider">

                </div>
            </div>
            <div class="col-lg-1">

                <div id="yearLabel">year</div>
                <div id="seasonLabel">season</div>

            </div>  
        </div>
        <!-- /.slider -->

        <hr>

        <!-- Info section -->
        <div class="row">
            <div class="col-lg-12">
                <div class="infoSection">
                    
                        <p> Dots are individual fish, with radius proportional to body length. Pick a species (Brook trout, Brown trout, Atlantic salmon) and a river (West Brook [WB], and the tributaries Open large [OL], Open small [OS], Isolated large [IL]) to show using dropdowns.</p>
                        <p>Move the slider to advance seasonal samples. Recaptured fish will change y-axis position if they were observed to move and change x-axis position based on body growth. Newly tagged fish on the sample will initially appear as green and fish that are never seen again will turn red and disappear.  </p>
  <p>Select individual fish by clicking on a dot. Unselect a selected individual by clicking on it again. Select an individual and other fish from the same full-sib family (brook trout only, at this point, 2001-2009) by selecting 'Family' in the 'Click' dropdown and clicking. The moseover for dots shows the fish #, the family # if know and the total number of fish in the selected fish's family. Selected fish will show a trace of all sizes/locations for each fish either for all samples the fish was known to be alive ("All" in the "Lines" dropdown) or for past ("Before"), future ("After"), or no ("None") samples. Circles of fish that were captured on an occasion are filled in and fish that were not captured (current sample location set equal to previous sample and length interpolated linearly, for now) are filled with grey. View just the selected fish or show all individuals by choosing 'Selected' in the 'Dots' dropdown. </p>
  
  <p> Bars on the sides of the graphs sum up the count or biomass (depending on which dropdowns are selected) for each section (left) or distance moved (right). Click on a bar to select the fish in that section. control-click on a different bar to add fish from another section</p>
                    
                </div>
            </div>
        </div>
        <!-- /.row -->

        <hr>

        <!-- Footer -->
        <footer>
            <div class="row">
                <div class="col-lg-12">
                    <p>Data from USGS Conte Lab <a href="http://www.lsc.usgs.gov/?q=cafb-population-dynamics-personnel">Ecology Section</a></p>
                </div>
            </div>
            <!-- /.row -->
        </footer>

    
    </div>
    <!-- /.container -->

    <script type='text/javascript' src="js/globalVariables.js"></script>   
    <script type='text/javascript' src="js/functions.js"></script>
    
    <script>

     function render(state,seconds) {
       console.log('render', state);
       
       updateAxes(state,seconds);
       updateRenderData(state);
       $("#seasonLabel").html(state.currentSampleDataAll[0].season);
       $("#yearLabel").html(state.currentSampleDataAll[0].year);
       
       getBarData1(state);
       getBarData2(state);

       render1(state,seconds);
       render2(state,seconds);
     }
     
//////////////////////////////      
///// Absolute position //////

    function render1(state,seconds){
       console.log('render1',state);
             
/////////////////////////////////////////////////////////////////////////
// Bars - put before circles so circles are on top
/////////////////////////////////////////////////////////////////////////    
// Update absolute position plots 
///////////////////////////////////////////////////////////////////////// 

      // BIND DATA
      var bars = svg1.selectAll("rect")
            .data(state.barData1);
      
      // APPEND NEW bar for each data element that doesn't already have a bar
      bars.enter().append("rect")
            .style("fill-opacity", 1e-6)

            .on("click", clickBar)

            .on("mouseover.Tip", tipBar.show)
            .on("mouseover.Color", mouseOverColorBar)
            .on('mouseout.Tip', tipBar.hide)
            .on('mouseout.Color', mouseOutColorBar)
      ;

      // UPDATE the color/position/size of each bar that has a data element
      bars
        .transition()
          .duration(1000*seconds)
            .attr("fill", "lightgrey")
            .style("fill-opacity", 1)
            .attr("x", function(d, i) {
			   		  return xScale(state.maxLength) - barScale1(d);
			      })
			      .attr("y", function(d,i) {
			   	  	return yScale(i+1.5);// ; 
			      })
			      .attr("height", (h/state.maxSection/1.75 ))
			      .attr("width", function(d) {
			   	  	return barScale1(d); //barScale1(d);
			      })
        ;
  
      // REMOVE any existing bars that no longer have data
      bars.exit()
   //       .style("fill", "red")
          .transition()
          .duration(1000*seconds)
          .style("fill-opacity", 1e-3)
       .remove();
          
/////////////////////////////////////////////////////////////////////////
// Circles
/////////////////////////////////////////////////////////////////////////    
// Update absolute position plots 
///////////////////////////////////////////////////////////////////////// 

      // BIND DATA
      var circles = svg1.selectAll("circle")
            .data(state.renderData, keyID);

      // APPEND NEW CIRCLE for each data element that doesn't already have a circle
      circles.enter().append("circle")
        .style("fill",  "green") //function(d  ){ return colorScale( color(d) ); })
        .style("stroke","darkgrey")
        .style("fill-opacity", 1e-6)
        
        .on("click", clickDot)
    //   .on('mouseover', mouseOverDot))   
        .on('mouseover', tip.show) 
   //     .on('mouseout', mouseOutDot)
        .on('mouseout', tip.hide)
      ;


      // UPDATE the color/position/size of each circle that has a data element
      circles
        .transition()
        .duration(1000*seconds)
          .style("fill", colorWithSelected)// function(d  ){ return colorScale( color(d) ); })
          .style("stroke",strokeWithSelected)
          .style("stroke-width",1)
          .style("fill-opacity", 1)
          .call(position)
      ;

      // REMOVE any existing circles that no longer have data
      circles.exit()
        .style("fill", "red")
        .style("stroke", "red")
        .transition()
        .duration(1000*seconds/3)
          .style("stroke",strokeWithSelected) 
          .style("fill-opacity", 1e-3)
          .style("stroke-opacity", 1e-3)
        .remove();
       
/////Trace lines
//
/*     if (state.currentSample > state.sampSet[0]) {

        console.log(state.selectedID);
     
        var circleLine = svg1.selectAll("line")
           .data(state.previousSampleDataSelected,keyID);

          circleLine.enter()
            .append("line")
            .attr("stroke", function(d){ return colorScale(color(d)); })
            .attr("stroke-width", 2);

          circleLine
            .attr("x1",function(d) { return xScale(x(d)); })
            .attr("y1",function(d) { return yScale(y(d)); })
            .data(state.currentSampleDataSelected,keyID)
              .transition()
              .duration(1000*seconds)
                .attr("x2", function(d) { return xScale(x(d)); })
                .attr("y2", function(d) { return yScale(y(d)); }) 

          ;
      //    console.log("circleLine", circleLine.attr.x1)
          
          circleLine.exit().remove();
    }
*/      
// add paths for all samples of selected fish
//
       // set in linesDD
       switch(state.lines) {
          case "before":
              state.filteredAliveSamplesSelected = filterSampleDataBefore(state.aliveSamplesSelected,state.currentSample);
              break;
          case "after":
              state.filteredAliveSamplesSelected = filterSampleDataAfter(state.aliveSamplesSelected,state.currentSample);
              break;
          case "all": //before and after ("all")
              state.filteredAliveSamplesSelected = state.aliveSamplesSelected; 
              break;
          case "none":
              state.filteredAliveSamplesSelected = [];
              break;
          default: 
              state.filteredAliveSamplesSelected = state.aliveSamplesSelected;
       }

       selectedPaths = state.selectedID.map(function (id) {
         return {
           id: id,
           samples: getDataID(state.filteredAliveSamplesSelected, id).map(function (d) {
             return {
               xx: d.len,
               yy: d.section
             }
           })
         }
       });  
        
       var lines = d3.svg.line()
         .x(function(d,i) { return xScale(d.xx); })
         .y(function(d,i) { return yScale(d.yy); })
       ;
 
       var paths = svg1.selectAll("path.samples")
          .data(selectedPaths,keyID);
          
       paths.enter().append("path")
         .attr('class', 'line samples')
       ;
      
       paths
        .attr("d", function(d){ return lines(d.samples) })
   //     .attr('stroke', strokeWithSelected)
          .transition()
          .duration(1000*seconds)
            .style("stroke",strokeWithSelected)
            .style("stroke-width",2)
            .style("fill-opacity", 1)
       ;

       paths.exit()
         .transition()
         .duration(1000*seconds/2)
         .remove();
         
    } //render1
  
//////////////////////////////      
///// Relative position //////

    function render2(state,seconds){
      console.log('render2');

/////////////////////////////////////////////////////////////////////////
// Bars - put before circles so circles are on top
/////////////////////////////////////////////////////////////////////////    
// Update relative position plots 
/////////////////////////////////////////////////////////////////////////

      // BIND DATA
      var bars = svg2.selectAll("rect")
            .data(state.barData2);
      
      // APPEND NEW bar for each data element that doesn't already have a bar
      bars.enter().append("rect")
            .style("fill-opacity", 1e-6)
            .on('mouseover', tipBar.show)
            .on('mouseout', tipBar.hide)
      ;

      // UPDATE the color/position/size of each bar that has a data element
      bars
        .transition()
          .duration(1000*seconds)
            .attr("fill", "grey")
            .style("fill-opacity", 1)
            .attr("x", function(d, i) {
			   		  return xScale2(state.maxLength) - barScale2(d + 0.0001) ;
			      })
			      .attr("y", function(d,i) {
			   	  	return yScale2Bar(i);// ; 
			      })
			      .attr("height", (h/state.maxSection/3.25 ))
			      .attr("width", function(d) {
			   	  	return barScale2(d + 0.0001);
			      })
        ;
  
      // REMOVE any existing bars that no longer have data
      bars.exit()
   //       .style("fill", "red")
          .transition()
          .duration(1000*seconds)
          .style("fill-opacity", 1e-3)
       .remove();
    
            
/////////////////////////////////////////////////////////////////////////
// Circles
/////////////////////////////////////////////////////////////////////////    
// Update relative position plots 
/////////////////////////////////////////////////////////////////////////

      // BIND DATA
      var circles2 = svg2.selectAll("circle")
            .data(state.renderData2, keyID);

      // APPEND NEW CIRCLE for each data element that doesn't already have a circle
      circles2.enter().append("circle")
        .style("fill",  "green") //function(d  ){ return colorScale( color(d) ); })
        .style("stroke","darkgrey")
        .style("fill-opacity", 1e-6)
        
        .on("click", clickDot)
        .on('mouseover', mouseOverDot)   
        .on('mouseover', tip.show) 
   //     .on('mouseout', mouseOutDot)
        .on('mouseout', tip.hide)
      ;


      // UPDATE the color/position/size of each circle that has a data element
      circles2
        .transition()
        .duration(1000*seconds)
          .style("fill", colorWithSelected)// function(d  ){ return colorScale( color(d) ); })
          .style("stroke",strokeWithSelected)
          .style("stroke-width",1)
          .style("fill-opacity", 1)
          .call(position2)
      ;

      // REMOVE any existing circles that no longer have data
      circles2.exit()
        .style("fill", "red")
        .style("stroke", "red")
        .transition()
        .duration(1000*seconds/3)
          .style("stroke",strokeWithSelected) 
          .style("fill-opacity", 1e-3)
          .style("stroke-opacity", 1e-3)
        .remove();
    
         };


       // get data and filter based on selections
       d3.csv("coreDataOut.csv", type,  function (csvData){
         
         state.allData = csvData;
 
         initializeChart();
         initializeState();
         initializeInterface();
         updateRiverSpecies(state);
         initializeAxes(state);
         render(state,1);

       });
        
    </script>



</body>
</html>
